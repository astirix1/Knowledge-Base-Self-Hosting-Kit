"""
Upgrade information API endpoints.
Provides information about upgrading from Developer to Team Edition.
"""

from fastapi import APIRouter, Depends
from typing import Dict, Any, List

from src.services.auth_service import get_current_user
from src.database.models import User
from src.core.feature_limits import FeatureLimits, Edition

router = APIRouter()


@router.get("/upgrade/info")
async def get_upgrade_info(
    current_user: User = Depends(get_current_user)
) -> Dict[str, Any]:
    """
    Get information about upgrading from Developer to Team Edition.
    
    Returns:
        Dictionary with upgrade benefits and feature comparisons
    """
    current_edition = Edition.DEVELOPER  # Current user is on Developer edition
    target_edition = Edition.TEAM  # Upgrade to Team edition
    
    current_limits = FeatureLimits.get_limits(current_edition)
    target_limits = FeatureLimits.get_limits(target_edition)
    
    # Compare features between editions
    feature_comparison = {
        "collections": {
            "current": current_limits["max_collections"],
            "upgrade": target_limits["max_collections"],
            "benefit": "Erstellen Sie bis zu 10 Wissenssammlungen anstelle von nur einer"
        },
        "documents_per_collection": {
            "current": current_limits["max_documents_per_collection"],
            "upgrade": target_limits["max_documents_per_collection"],
            "benefit": "Speichern Sie bis zu 5.000 Dokumente pro Sammlung anstelle von nur 100"
        },
        "file_formats": {
            "current": current_limits["allowed_file_formats"],
            "upgrade": target_limits["allowed_file_formats"],
            "benefit": "Unterstützung für mehr Dateiformate (DOCX, TXT, MD, HTML) anstelle von nur PDF"
        },
        "advanced_rag": {
            "current": current_limits["enable_advanced_rag"],
            "upgrade": target_limits["enable_advanced_rag"],
            "benefit": "Zugriff auf fortgeschrittene RAG-Funktionen wie Parent-Child-Strategie"
        },
        "cross_encoder_reranking": {
            "current": current_limits["enable_cross_encoder_reranking"],
            "upgrade": target_limits["enable_cross_encoder_reranking"],
            "benefit": "Genauere Suchergebnisse durch Cross-Encoder Reranking"
        },
        "learning_system": {
            "current": current_limits["enable_learning_system"],
            "upgrade": target_limits["enable_learning_system"],
            "benefit": "Lernsystem für kontinuierliche Verbesserung der Antwortqualität"
        },
        "auto_draft": {
            "current": current_limits["enable_auto_draft"],
            "upgrade": target_limits["enable_auto_draft"],
            "benefit": "Automatische Erstellung von E-Mail-Antwortentwürfen"
        },
        "multi_collection_search": {
            "current": current_limits["enable_multi_collection_search"],
            "upgrade": target_limits["enable_multi_collection_search"],
            "benefit": "Suche gleichzeitig in mehreren Wissenssammlungen"
        },
        "team_sharing": {
            "current": current_limits["enable_team_sharing"],
            "upgrade": target_limits["enable_team_sharing"],
            "benefit": "Teilen Sie Ihre Wissenssammlungen mit Teammitgliedern"
        },
        "batch_processing": {
            "current": current_limits["enable_batch_processing"],
            "upgrade": target_limits["enable_batch_processing"],
            "benefit": "Verarbeiten Sie mehrere Dokumente gleichzeitig"
        }
    }
    
    # Benefits summary
    benefits = [
        "Unbegrenzter Zugriff auf alle RAG-Funktionen",
        "Unterstützung für verschiedene Dokumentformate",
        "Team-Zugriff und Kollaboration",
        "Erweiterte Analytik und Berichte",
        "Priorisierter Support",
        "Zukünftige Funktionen und Updates"
    ]
    
    # Pricing info (placeholder)
    pricing = {
        "monthly_price": "49€",
        "annual_price": "490€",
        "per_user": True,
        "trial_days": 14,
        "billed_annually": True
    }
    
    upgrade_info = {
        "current_edition": current_edition.value,
        "target_edition": target_edition.value,
        "feature_comparison": feature_comparison,
        "benefits": benefits,
        "pricing": pricing,
        "cta_text": "Jetzt Team Edition erhalten",
        "upgrade_url": "/upgrade-process",  # Placeholder for actual upgrade process
        "trial_available": True,
        "trial_duration_days": 14
    }
    
    return upgrade_info


@router.get("/upgrade/benefits")
async def get_upgrade_benefits(
    current_user: User = Depends(get_current_user)
) -> Dict[str, Any]:
    """
    Get specific benefits of upgrading to Team Edition.
    
    Returns:
        Dictionary with specific benefits for different user types
    """
    benefits_by_use_case = {
        "small_team": {
            "title": "Für kleine Teams",
            "description": "Kollaborieren Sie effektiv mit Ihren Kollegen",
            "features": [
                "Gemeinsamer Zugriff auf Wissenssammlungen",
                "Team-basierte Berechtigungen",
                "Zentrale Verwaltung"
            ]
        },
        "professional": {
            "title": "Für professionelle Anwender",
            "description": "Erweiterte Funktionen für komplexe Anwendungsfälle",
            "features": [
                "Fortgeschrittene RAG-Techniken",
                "Cross-Encoder Reranking",
                "Batch-Verarbeitung"
            ]
        },
        "enterprise": {
            "title": "Für Unternehmen",
            "description": "Skalierbare Lösung für große Organisationen",
            "features": [
                "Unbegrenzte Sammlungen",
                "Erweiterte Sicherheitsfunktionen",
                "Priorisierter Support"
            ]
        }
    }
    
    return {
        "benefits_by_use_case": benefits_by_use_case,
        "roi_examples": [
            {
                "example": "Zeitersparnis bei Recherche",
                "savings": "Bis zu 5 Stunden pro Woche",
                "description": "Automatisierte Suche und Wissensabruf statt manueller Recherche"
            },
            {
                "example": "Verbesserte Antwortqualität",
                "savings": "Bis zu 30% höhere Kundenzufriedenheit",
                "description": "Konsistente, qualitativ hochwertige Antworten basierend auf Ihrem Wissen"
            }
        ]
    }


@router.post("/upgrade/request-trial")
async def request_trial(
    current_user: User = Depends(get_current_user)
) -> Dict[str, Any]:
    """
    Request a trial of the Team Edition.
    
    Returns:
        Dictionary with trial status and next steps
    """
    # In a real implementation, this would track the trial request in the database
    # For now, we return a success message
    
    return {
        "success": True,
        "trial_started": True,
        "trial_days": 14,
        "expires_at": "2025-12-03",  # Placeholder date
        "next_steps": [
            "Sie erhalten eine E-Mail mit Ihren Zugangsdaten",
            "Installieren Sie die Team Edition",
            "Importieren Sie Ihre bestehenden Sammlungen"
        ],
        "support_contact": "trial@company.com"
    }