services:
  # nginx Gateway - Single entry point for all traffic
  gateway:
    image: nginx:alpine
    container_name: self-hosting-kit-gateway
    ports:
      - "${PORT:-8080}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend:/usr/share/nginx/html:ro
    depends_on:
      backend:
        condition: service_started
    networks:
      - frontend
      - backend
    restart: unless-stopped

  # ChromaDB - Vector Database (internal only)
  chromadb:
    image: chromadb/chroma:0.5.23
    container_name: self-hosting-kit-chromadb
    expose:
      - "8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c 'cat < /dev/null > /dev/tcp/localhost/8000' 2>/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # FastAPI Backend (internal only)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: self-hosting-kit-backend
    expose:
      - "8080"
    environment:
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      - LLM_MODEL=${LLM_MODEL:-llama3.1:8b-instruct-q4_k_m}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-ollama}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      chromadb:
        condition: service_healthy
    volumes:
      - ${DOCS_DIR:-./data/docs}:/host_root:ro  # Mount specific docs folder (read-only)
      - ./backend/src:/app/src:ro  # Mount source code for live reload (development)
      - docling_cache:/app/cache   # Persistent cache for OCR/Conversion
    networks:
      - backend
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Enable host.docker.internal on Linux
    restart: unless-stopped

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

volumes:
  chroma_data:
  docling_cache:
